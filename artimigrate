#!/bin/bash

set -e

usage() {
    echo "Usage: $0 -s SOURCE_ARTIFACTORY_URL -t TARGET_ARTIFACTORY_URL [-k ARTI3_KEY] -sr SOURCE_REPO -tr TARGET_REPO"
    exit 1
}

while getopts ":s:t:k:sr:tr:" opt; do
    case ${opt} in
        s)
            SOURCE_ARTIFACTORY_URL=${OPTARG}
            ;;
        t)
            TARGET_ARTIFACTORY_URL=${OPTARG}
            ;;
        k)
            ARTI3_KEY=${OPTARG}
            ;;
        sr)
            SOURCE_REPO=${OPTARG}
            ;;
        tr)
            TARGET_REPO=${OPTARG}
            ;;
        \?)
            echo "Invalid option: -$OPTARG"
            usage
            ;;
        :)
            echo "Option -$OPTARG requires an argument."
            usage
            ;;
    esac
done

# Validate required options
if [[ -z $SOURCE_ARTIFACTORY_URL && -z $TARGET_ARTIFACTORY_URL && -z $SOURCE_REPO && -z $TARGET_REPO ]]; then
    echo "Missing required options!"
    usage
fi

# If ARTI3_KEY is not set, prompt for it
if [[ -z $ARTI3_KEY ]]; then
    read -sp "Enter Artifactory API key: " ARTI3_KEY
    echo
fi

# Function to list all artifacts in a repository
list_artifacts() {
    local repo_url="$1"
    local repo_name="$2"

    curl -sS -H "Authorization: Bearer $ARTI3_KEY" "$repo_url/$repo_name/" | grep -oP '(?<=href=")[^"]+(?=")'
}

# Function to copy artifacts from source to target repository
copy_artifacts() {
    local source_url="$1"
    local target_url="$2"
    local source_repo="$3"
    local target_repo="$4"

    for artifact in $(list_artifacts "$source_url" "$source_repo"); do
        echo "Copying: $artifact"
        curl -X COPY -H "Authorization: Bearer $ARTI3_KEY" "$source_url/$source_repo/$artifact" -H "Destination: $target_url/$target_repo/$artifact"
    done
}

# Main migration function
migrate_artifacts() {
    echo "Migrating artifacts from $SOURCE_ARTIFACTORY_URL/$SOURCE_REPO to $TARGET_ARTIFACTORY_URL/$TARGET_REPO"

    # Create the target repository if it doesn't exist
    curl -X PUT -H "Authorization: Bearer $ARTI3_KEY" "$TARGET_ARTIFACTORY_URL/api/repositories/$TARGET_REPO"

    # Copy artifacts
    copy_artifacts "$SOURCE_ARTIFACTORY_URL/api/storage" "$TARGET_ARTIFACTORY_URL/api/storage" "$SOURCE_REPO" "$TARGET_REPO"

    echo "Migration complete!"
}

# Execute the migration
migrate_artifacts
